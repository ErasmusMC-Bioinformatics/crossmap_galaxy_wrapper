<tool id="crossmap" name="CrossMap" version="0.1.8">
    <description>Convert genome coordinates or annotation files between genome assemblies</description>
    
    <requirements>
        <requirement type="package" version="0.1.8">crossmap</requirement>
    </requirements>
    
    <stdio></stdio>

    <command>
        CrossMap.py
            $multiple.input_format
            
            #if $multiple.seq_source.index_source == "history" or $multiple.seq_source.index_source == "history_fasta"
                $multiple.seq_source.input_chain
            #else
                $multiple.seq_source.input_chain
            #end if
                        
            #if $multiple.input_format == "bam"
                -m $multiple.insert_size
                -s $multiple.insert_size_stdev
                -t $multiple.insert_size_fold
            #else if $multiple.input_format == "vcf"
                $multiple.seq_source.input_fasta
            #end if
            
            $multiple.seq_source.input
            $output
    </command>

    <inputs>
        <conditional name="multiple">
            <param name="input_format" type="select" label="Convert a file of the following format">
                <option value="bam">BAM or SAM format</option>
                <option value="bed">BED or BED-like</option>
                <option value="bigwig">BigWig</option>
                <option value="gff">GFF or GTF</option>
                <option value="vcf">VCF</option>
                <option value="wig">Wiggle or bedGraph</option>
            </param>
            <when value="bam">
                <conditional name="seq_source">
                    <param name="index_source" type="select" label="Source for LiftOver Data (chain file)">
                        <option value="cached">Local data (in galaxy)</option>
                        <option value="history">From History</option>
                    </param>
                        <when value="cached">
                            <param type="data" format="bam,sam" name="input" label="BAM/SAM file">
                                <validator type="unspecified_build" />
                                <validator type="dataset_metadata_in_file" filename="liftOver.loc" metadata_name="dbkey" metadata_column="0" message="LiftOver mapping (chain file) is not available for the specified build." />
                            </param>
                            <param name="input_chain" type="select" label="Lift Over To">
                                <options from_file="liftOver.loc">
                                    <column name="name" index="1"/>
                                    <column name="value" index="2"/>
                                    <column name="dbkey" index="0"/>
                                    <filter type="data_meta" ref="input" key="dbkey" column="0" />
                                </options>
                            </param>
                        </when>
                        <when value="history">
                            <param type="data" format="bam,sam" name="input" label="BAM/SAM file" />
                            <param type="data" name="input_chain" label="LiftOver chain file" />
                        </when>
                </conditional>
                
                <param name="insert_size" type="float" value="200.0" label="Insert size (-m)" help="Average insert size of pair-end sequencing (bp) [default=200.0]" />
                <param name="insert_size_stdev" type="float" value="30.0" label="Insert size std. dev (-s)" help="Stanadard deviation of insert size. [default=30.0]" />
                <param name="insert_size_fold" type="float" value="3.0" label="Insert size std. dev foldchange (-t)" help="A mapped pair is considered as 'proper pair' if both ends mapped to different strand and the distance between them is less then '-t' * stdev from the mean. [default=3.0]" />
            </when>
            <when value="bed">
                <conditional name="seq_source">
                    <param name="index_source" type="select" label="Source for LiftOver Data (chain file)">
                        <option value="cached">Local data (in galaxy)</option>
                        <option value="history">From History</option>
                    </param>
                        <when value="cached">
                            <param format="bed" name="input" type="data" label="BED file" help="BED format file must have at least 3 columns (chrom, start, end) and no more than 12 columns.">
                                <validator type="unspecified_build" />
                                <validator type="dataset_metadata_in_file" filename="liftOver.loc" metadata_name="dbkey" metadata_column="0" message="LiftOver mapping (chain file) is not available for the specified build." />
                            </param>
                            <param name="input_chain" type="select" label="Lift Over To">
                                <options from_file="liftOver.loc">
                                    <column name="name" index="1"/>
                                    <column name="value" index="2"/>
                                    <column name="dbkey" index="0"/>
                                    <filter type="data_meta" ref="input" key="dbkey" column="0" />
                                </options>
                            </param>
                        </when>
                        <when value="history">
                            <param format="bed" name="input" type="data" label="BED file" help="BED format file must have at least 3 columns (chrom, start, end) and no more than 12 columns." />
                            <param type="data" name="input_chain" label="LiftOver chain file" />
                        </when>
                </conditional>
            </when>
            <when value="bigwig">
                <conditional name="seq_source">
                    <param name="index_source" type="select" label="Source for LiftOver Data (chain file)">
                        <option value="cached">Local data (in galaxy)</option>
                        <option value="history">From History</option>
                    </param>
                        <when value="cached">
                            <param format="bigwig" name="input" type="data" label="BigWig file">
                                <validator type="unspecified_build" />
                                <validator type="dataset_metadata_in_file" filename="liftOver.loc" metadata_name="dbkey" metadata_column="0" message="LiftOver mapping (chain file) is not available for the specified build." />
                            </param>
                            <param name="input_chain" type="select" label="Lift Over To">
                                <options from_file="liftOver.loc">
                                    <column name="name" index="1"/>
                                    <column name="value" index="2"/>
                                    <column name="dbkey" index="0"/>
                                    <filter type="data_meta" ref="input" key="dbkey" column="0" />
                                </options>
                            </param>
                        </when>
                        <when value="history">
                            <param format="bigwig" name="input" type="data" label="BigWig file" />
                            <param type="data" name="input_chain" label="LiftOver chain file" />
                        </when>
                </conditional>
            </when>
            <when value="gff">
                <conditional name="seq_source">
                    <param name="index_source" type="select" label="Source for LiftOver Data (chain file)">
                        <option value="cached">Local data (in galaxy)</option>
                        <option value="history">From History</option>
                    </param>
                        <when value="cached">
                            <param format="gtf,gff,gff3" name="input" type="data" label="GTF/GFF file">
                                <validator type="unspecified_build" />
                                <validator type="dataset_metadata_in_file" filename="liftOver.loc" metadata_name="dbkey" metadata_column="0" message="LiftOver mapping (chain file) is not available for the specified build." />
                            </param>
                            <param name="input_chain" type="select" label="Lift Over To">
                                <options from_file="liftOver.loc">
                                    <column name="name" index="1"/>
                                    <column name="value" index="2"/>
                                    <column name="dbkey" index="0"/>
                                    <filter type="data_meta" ref="input" key="dbkey" column="0" />
                                </options>
                            </param>
                        </when>
                        <when value="history">
                            <param format="gtf,gff,gff3" name="input" type="data" label="GTF/GFF file" />
                            <param type="data" name="input_chain" label="LiftOver chain file" />
                        </when>
                </conditional>
            </when>
            <when value="vcf">
                <conditional name="seq_source">
                    <param name="index_source" type="select" label="Source for LiftOver Data">
                        <option value="cached">Local data (in galaxy)</option>
                        <option value="history_chain">Chain from History</option>
                        <option value="history_fasta">FASTA from History</option>
                        <option value="history_all">Chain &amp; FASTA from History</option>
                    </param>
                        <when value="cached">
                            <param type="data" format="vcf" name="input" label="VCF file">
                                <validator type="unspecified_build" />
                                <validator type="dataset_metadata_in_file" filename="liftOver.loc" metadata_name="dbkey" metadata_column="0" message="LiftOver mapping (chain file) is not available for the specified build." />
                            </param>
                            
                            <param name="input_chain" type="select" label="Lift Over To (Chain file)">
                                <options from_file="liftOver.loc">
                                    <column name="name" index="1"/>
                                    <column name="value" index="2"/>
                                    <column name="dbkey" index="0"/>
                                    <filter type="data_meta" ref="input" key="dbkey" column="0" />
                                </options>
                            </param>
                            
                            <param name="input_fasta" type="select" label="Lift Over To (FASTA file)" help="Must be identical to the Chain file!">
                                <options from_file="all_fasta.loc">
                                    <column name="name" index="2"/>
                                    <column name="value" index="3"/>
                                    <column name="dbkey" index="1"/>
                                </options>
                            </param>
                        </when>
                        
                        <when value="history_chain">
                            <param type="data" format="vcf" name="input" label="VCF file">
                                <validator type="unspecified_build" />
                                <validator type="dataset_metadata_in_file" filename="all_fasta.loc" metadata_name="dbkey" metadata_column="1" message="LiftOver mapping (FASTA file) is not available for the specified build." />
                            </param>
                            <param type="data"  name="input_chain" multiple="false" label="LiftOver chain file" />
                            <param name="input_fasta" type="select" label="Lift Over To (FASTA file)" help="Must be identical to the Chain file!">
                                <options from_file="all_fasta.loc">
                                    <column name="name" index="2"/>
                                    <column name="value" index="3"/>
                                    <column name="dbkey" index="1"/>
                                </options>
                            </param>
                        </when>
                        
                        <when value="history_fasta">
                            <param type="data" format="vcf" name="input" label="VCF file">
                                <validator type="unspecified_build" />
                                <validator type="dataset_metadata_in_file" filename="liftOver.loc" metadata_name="dbkey" metadata_column="0" message="Liftover mappings are currently not available for the specified build." />
                            </param>
                            <param type="data" format="fasta" name="input_fasta" multiple="false" label="Full genome FASTA file" />
                        </when>
                        
                        <when value="history_all">
                            <param type="data" format="vcf"   name="input" label="VCF file" />
                            <param type="data"                name="input_all_chain" multiple="false" label="LiftOver chain file" />
                            <param type="data" format="fasta" name="input_all_fasta" multiple="false" label="Full genome FASTA file" />
                        </when>
                </conditional>
            </when>
            <when value="wig">
                <conditional name="seq_source">
                    <param name="index_source" type="select" label="Source for LiftOver Data (chain file)">
                        <option value="cached">Local data (in galaxy)</option>
                        <option value="history">From History</option>
                    </param>
                        <when value="cached">
                            <param format="wig" name="input" type="data" label="Wiggle file">
                                <validator type="unspecified_build" />
                                <validator type="dataset_metadata_in_file" filename="liftOver.loc" metadata_name="dbkey" metadata_column="0" message="LiftOver mapping (chain file) is not available for the specified build." />
                            </param>
                            <param name="input_chain" type="select" label="Lift Over To">
                                <options from_file="liftOver.loc">
                                    <column name="name" index="1"/>
                                    <column name="value" index="2"/>
                                    <column name="dbkey" index="0"/>
                                    <filter type="data_meta" ref="input" key="dbkey" column="0" />
                                </options>
                            </param>
                        </when>
                        <when value="history">
                            <param format="wig" name="input" type="data" label="Wiggle file" />
                            <param type="data" name="input_chain" label="LiftOver chain file" />
                        </when>
                </conditional>
            </when>
        </conditional>
    </inputs>
    
    <outputs>
        <data format="text" name="output" label="Output file">
        </data>
    </outputs>
    
    <tests>
        <test>
            <param name="input" value="test1.hg19.txt"/>
            <output name="output" file="test1.hg18.txt"/>
        </test>
    </tests>
    
    <help>
CrossMap is versatile tool to convert genome coordinates or annotation files between genome
assemblies. It supports mostly commonly used file types, including BAM, BED,BigWig, GFF,
GTF, SAM, Wiggle, and VCF formats. For large plain text file types, such as BED, GFF, GTF
and VCF, reading from remote servers and file compression are supported.
    </help>
    
    <citations>
        <citation type="doi">10.1093/bioinformatics/btt730</citation>
    </citations>
</tool>
